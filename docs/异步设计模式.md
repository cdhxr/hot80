

## ğŸ¯ 1. Promise æ ¸å¿ƒå®ç°

### æ¨å¯¼é“¾

```
Q1: Promise æ˜¯ä»€ä¹ˆï¼Ÿ
â†’ çŠ¶æ€æœºï¼špending â†’ fulfilled/rejectedï¼Œä¸å¯é€†
â†’ éœ€è¦ï¼šstateã€valueã€callbacks[]

Q2: resolve/reject å¹²å˜›ï¼Ÿ
â†’ æ”¹çŠ¶æ€ + å­˜å€¼ + æ‰§è¡Œæ‰€æœ‰ç­‰å¾…çš„å›è°ƒ
â†’ ä¸ºä»€ä¹ˆè¦ callbacksï¼Ÿå› ä¸º then å¯èƒ½åœ¨ pending æ—¶è°ƒç”¨

Q3: then ä¸ºä»€ä¹ˆèƒ½é“¾å¼è°ƒç”¨ï¼Ÿ
â†’ è¿”å›æ–° Promise
â†’ æ–° Promise çš„ resolve/reject ç”±ä¸Šä¸€ä¸ª then çš„è¿”å›å€¼å†³å®š

Q4: then çš„è¿”å›å€¼æ€ä¹ˆå¤„ç†ï¼Ÿ
â†’ æ™®é€šå€¼ï¼šç›´æ¥ resolve(result)
â†’ Promiseï¼šresult.then(resolve, reject) ç­‰å®ƒå®Œæˆ

Q5: ä¸ºä»€ä¹ˆè¦ setTimeoutï¼Ÿ
â†’ è§„èŒƒè¦æ±‚ then å›è°ƒå¼‚æ­¥æ‰§è¡Œ

Q6: é€ä¼ æ˜¯ä»€ä¹ˆï¼Ÿ
â†’ .then().then(v => ...) å€¼è¦èƒ½ä¼ ä¸‹å»
â†’ é»˜è®¤ v => v å’Œ e => { throw e }
```

### ä»£ç å®ç°

```javascript
const PENDING = 'pending'
const FULFILLED = 'fulfilled'
const REJECTED = 'rejected'

class MyPromise {
  constructor(executor) {
    this.state = PENDING
    this.value = undefined
    this.callbacks = []

    const resolve = (value) => {
      if (this.state !== PENDING) return
      this.state = FULFILLED
      this.value = value
      this.callbacks.forEach(cb => cb.onFulfilled(value))
    }

    const reject = (reason) => {
      if (this.state !== PENDING) return
      this.state = REJECTED
      this.value = reason
      this.callbacks.forEach(cb => cb.onRejected(reason))
    }

    try {
      executor(resolve, reject)
    } catch (e) {
      reject(e)
    }
  }

  then(onFulfilled, onRejected) {
    // å‚æ•°é€ä¼ å¤„ç†
    onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : v => v
    onRejected = typeof onRejected === 'function' ? onRejected : e => { throw e }

    return new MyPromise((resolve, reject) => {
      const handle = (callback) => {
        try {
          const result = callback(this.value)
          // å¤„ç†è¿”å›å€¼ï¼šPromise æˆ–æ™®é€šå€¼
          result instanceof MyPromise 
            ? result.then(resolve, reject) 
            : resolve(result)
        } catch (e) {
          reject(e)
        }
      }

      // å¼‚æ­¥æ‰§è¡Œå›è°ƒï¼ˆè§„èŒƒè¦æ±‚ï¼‰
      if (this.state === FULFILLED) {
        return setTimeout(() => handle(onFulfilled))
      }
      if (this.state === REJECTED) {
        return setTimeout(() => handle(onRejected))
      }
      
      // pending çŠ¶æ€ï¼šæ”¶é›†å›è°ƒ
      this.callbacks.push({
        onFulfilled: () => setTimeout(() => handle(onFulfilled)),
        onRejected: () => setTimeout(() => handle(onRejected))
      })
    })
  }

  catch(onRejected) {
    return this.then(null, onRejected)
  }

  static resolve(v) {
    return v instanceof MyPromise ? v : new MyPromise(r => r(v))
  }

  static reject(e) {
    return new MyPromise((_, r) => r(e))
  }
}

// âœ… æµ‹è¯•
new MyPromise(r => setTimeout(() => r(1), 100))
  .then(v => { console.log(v); return v + 1 })
  .then(v => new MyPromise(r => setTimeout(() => r(v + 1), 100)))
  .then(console.log)  // è¾“å‡º: 1, 3
```

---

## ğŸ”„ 2. Promise.all

### æ¨å¯¼é“¾

```
Q1: all å¹²å˜›ï¼Ÿ
â†’ å…¨éƒ¨æˆåŠŸæ‰æˆåŠŸï¼Œä¸€ä¸ªå¤±è´¥å°±å¤±è´¥

Q2: æ€ä¹ˆçŸ¥é“å…¨éƒ¨å®Œæˆï¼Ÿ
â†’ è®¡æ•°å™¨ finished === total

Q3: ç»“æœé¡ºåºï¼Ÿ
â†’ results[index] æŒ‰ç´¢å¼•å­˜ï¼Œä¸è¾“å…¥é¡ºåºä¸€è‡´
```

### ä»£ç å®ç°

```javascript
Promise.myAll = function(promises) {
  return new Promise((resolve, reject) => {
    const results = []
    let finished = 0
    const arr = Array.from(promises)

    if (arr.length === 0) return resolve([])

    arr.forEach((p, i) => {
      // ç»Ÿä¸€è½¬ä¸º Promise å¤„ç†
      Promise.resolve(p).then(
        value => {
          results[i] = value
          if (++finished === arr.length) resolve(results)
        },
        reject  // ä¸€ä¸ªå¤±è´¥å°±æ•´ä½“å¤±è´¥
      )
    })
  })
}

// âœ… æµ‹è¯•
Promise.myAll([Promise.resolve(1), Promise.resolve(2), 3])
  .then(console.log)  // [1, 2, 3]

Promise.myAll([Promise.resolve(1), Promise.reject('err')])
  .catch(console.log)  // 'err'
```

---

## âš¡ 3. Promise.race

### æ¨å¯¼é“¾

```
Q1: race å¹²å˜›ï¼Ÿ
â†’ è°å…ˆå®Œæˆç”¨è°ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰

Q2: æ€ä¹ˆå®ç°ï¼Ÿ
â†’ æ¯ä¸ªéƒ½ .then(resolve, reject)ï¼Œç¬¬ä¸€ä¸ªè§¦å‘åçŠ¶æ€é”å®š
```

### ä»£ç å®ç°

```javascript
Promise.myRace = function(promises) {
  return new Promise((resolve, reject) => {
    for (const p of promises) {
      // ç¬¬ä¸€ä¸ª settle çš„ Promise å†³å®šç»“æœ
      Promise.resolve(p).then(resolve, reject)
    }
  })
}

// âœ… æµ‹è¯•
Promise.myRace([
  new Promise(r => setTimeout(() => r('slow'), 200)),
  new Promise(r => setTimeout(() => r('fast'), 100))
]).then(console.log)  // 'fast'
```

---

## âœ… 4. Promise.allSettled

### æ¨å¯¼é“¾

```
Q1: å’Œ all åŒºåˆ«ï¼Ÿ
â†’ ä¸ç®¡æˆåŠŸå¤±è´¥ï¼Œç­‰å…¨éƒ¨å®Œæˆ

Q2: è¿”å›æ ¼å¼ï¼Ÿ
â†’ { status: 'fulfilled'|'rejected', value|reason }
```

### ä»£ç å®ç°

```javascript
Promise.myAllSettled = function(promises) {
  return new Promise(resolve => {
    const results = []
    let finished = 0
    const arr = Array.from(promises)

    if (arr.length === 0) return resolve([])

    arr.forEach((p, i) => {
      Promise.resolve(p).then(
        value => { 
          results[i] = { status: 'fulfilled', value } 
        },
        reason => { 
          results[i] = { status: 'rejected', reason } 
        }
      ).finally(() => {
        if (++finished === arr.length) resolve(results)
      })
    })
  })
}

// âœ… æµ‹è¯•
Promise.myAllSettled([Promise.resolve(1), Promise.reject('err')])
  .then(console.log)
  // [
  //   { status: 'fulfilled', value: 1 }, 
  //   { status: 'rejected', reason: 'err' }
  // ]
```

---

## ğŸ† 5. Promise.any

### æ¨å¯¼é“¾

```
Q1: å’Œ race åŒºåˆ«ï¼Ÿ
â†’ ç¬¬ä¸€ä¸ªæˆåŠŸçš„ï¼Œå…¨å¤±è´¥æ‰å¤±è´¥

Q2: å…¨å¤±è´¥è¿”å›ä»€ä¹ˆï¼Ÿ
â†’ AggregateErrorï¼ˆåŒ…å«æ‰€æœ‰é”™è¯¯ï¼‰
```

### ä»£ç å®ç°

```javascript
Promise.myAny = function(promises) {
  return new Promise((resolve, reject) => {
    const errors = []
    let finished = 0
    const arr = Array.from(promises)

    if (arr.length === 0) {
      return reject(new AggregateError([], 'All promises were rejected'))
    }

    arr.forEach((p, i) => {
      Promise.resolve(p).then(
        value => resolve(value),  // ç¬¬ä¸€ä¸ªæˆåŠŸç›´æ¥ resolve
        reason => {
          errors[i] = reason
          if (++finished === arr.length) {
            reject(new AggregateError(errors, 'All promises were rejected'))
          }
        }
      )
    })
  })
}

// âœ… æµ‹è¯•
Promise.myAny([
  Promise.reject('err1'),
  Promise.resolve('success'),
  Promise.reject('err2')
]).then(console.log)  // 'success'
```

---

## ğŸ›ï¸ 6. å¹¶å‘æ§åˆ¶

### æ¨å¯¼é“¾

```
Q1: ä»€ä¹ˆåœºæ™¯ï¼Ÿ
â†’ 10ä¸ªè¯·æ±‚ï¼ŒåŒæ—¶æœ€å¤šè·‘3ä¸ª

Q2: æ€ä¹ˆæ§åˆ¶ï¼Ÿ
â†’ ç»´æŠ¤ executing æ± ï¼Œæ»¡äº†å°±ç­‰

Q3: æ€ä¹ˆç­‰ï¼Ÿ
â†’ Promise.race ç­‰æœ€å¿«å®Œæˆçš„

Q4: å®Œæˆåï¼Ÿ
â†’ ä»æ± å­åˆ æ‰ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
```

### ä»£ç å®ç°ï¼ˆasync/await ç‰ˆï¼‰

```javascript
async function schedule(tasks, limit) {
  const results = []
  const executing = new Set()

  for (const task of tasks) {
    const p = Promise.resolve().then(task)
    results.push(p)

    executing.add(p)
    
    // æ¸…ç†å·²å®Œæˆçš„ Promise
    const clean = () => executing.delete(p)
    p.then(clean, clean)

    // æ± å­æ»¡äº†å°±ç­‰
    if (executing.size >= limit) {
      await Promise.race(executing)
    }
  }

  return Promise.all(results)
}

// âœ… æµ‹è¯•
const tasks = [
  () => new Promise(r => setTimeout(() => { console.log('A'); r('A') }, 1000)),
  () => new Promise(r => setTimeout(() => { console.log('B'); r('B') }, 500)),
  () => new Promise(r => setTimeout(() => { console.log('C'); r('C') }, 800)),
  () => new Promise(r => setTimeout(() => { console.log('D'); r('D') }, 300)),
]

schedule(tasks, 2).then(console.log)
```

---

## ğŸ” 7. Retry é‡è¯• + è¶…æ—¶æ§åˆ¶

### æ¨å¯¼é“¾

```
Q1: retry æ€ä¹ˆå®ç°ï¼Ÿ
â†’ å¤±è´¥å°±é€’å½’ï¼Œæ¬¡æ•°å‡ä¸€

Q2: è¶…æ—¶æ€ä¹ˆæ§åˆ¶ï¼Ÿ
â†’ Promise.race([è¯·æ±‚, è¶…æ—¶Promise])

Q3: å¸¦å»¶è¿Ÿï¼Ÿ
â†’ å¤±è´¥å setTimeout å†é‡è¯•
```

### ä»£ç å®ç°

```javascript
// å¸¦é‡è¯• + è¶…æ—¶ + å»¶è¿Ÿ
function requestWithRetry(fn, { 
  retries = 3, 
  timeout = 5000, 
  delay = 1000 
} = {}) {
  return new Promise((resolve, reject) => {
    const attempt = (n) => {
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Timeout')), timeout)
      )

      Promise.race([fn(), timeoutPromise])
        .then(resolve)
        .catch(err => {
          if (n <= 0) return reject(err)
          console.log(`Retry ${retries - n + 1}/$
{retries}: ${err.message}`)
          setTimeout(() => attempt(n - 1), delay)
        })
    }
    attempt(retries)
  })
}

// âœ… æµ‹è¯•
let count = 0
const flakyRequest = () => new Promise((resolve, reject) => {
  if (++count < 3) {
    reject(new Error('Network error'))
  } else {
    resolve('Success!')
  }
})

requestWithRetry(flakyRequest, { retries: 5, delay: 500 })
  .then(console.log)  // Success!
```

---

## ğŸ˜´ 8. Sleep

### æ¨å¯¼é“¾

```
Q1: sleep å¹²å˜›ï¼Ÿ
â†’ ç­‰å¾…æŒ‡å®šæ—¶é—´

Q2: æ€ä¹ˆå®ç°ï¼Ÿ
â†’ Promise + setTimeout
```

### ä»£ç å®ç°

```javascript
// åŸºç¡€ç‰ˆ
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms))
}

// âœ… ä½¿ç”¨
async function demo() {
  console.log('Start')
  await sleep(1000)
  console.log('After 1s')
}

// å¯å–æ¶ˆç‰ˆ
function sleepCancelable(ms) {
  let timer
  const promise = new Promise((resolve, reject) => {
    timer = setTimeout(resolve, ms)
  })
  promise.cancel = () => {
    clearTimeout(timer)
    // å¯é€‰ï¼šreject è¡¨ç¤ºå–æ¶ˆ
  }
  return promise
}
```

---

## ğŸš¦ 9. çº¢ç»¿ç¯å¾ªç¯

### æ¨å¯¼é“¾

```
Q1: éœ€æ±‚ï¼Ÿ
â†’ çº¢3s â†’ ç»¿2s â†’ é»„1s â†’ å¾ªç¯

Q2: æ€ä¹ˆä¸²è¡Œï¼Ÿ
â†’ async/await æˆ– Promise é“¾

Q3: æ€ä¹ˆå¾ªç¯ï¼Ÿ
â†’ é€’å½’æˆ– while(true)
```

### ä»£ç å®ç°

```javascript
// æ–¹æ¡ˆä¸€ï¼šasync/await + é€’å½’
function redGreenLight() {
  const lights = [
    { color: 'ğŸ”´ çº¢', duration: 3000 },
    { color: 'ğŸŸ¢ ç»¿', duration: 2000 },
    { color: 'ğŸŸ¡ é»„', duration: 1000 },
  ]

  const run = async (index = 0) => {
    const { color, duration } = lights[index]
    console.log(color)
    await sleep(duration)
    run((index + 1) % lights.length)  // å¾ªç¯
  }
  
  run()
}

// æ–¹æ¡ˆäºŒï¼šPromise é“¾ + é€’å½’
function redGreenLightChain() {
  const task = (color, duration, next) => {
    return new Promise(resolve => {
      console.log(color)
      setTimeout(() => {
        next ? next().then(resolve) : resolve()
      }, duration)
    })
  }

  const loop = () => {
    return task('ğŸ”´ çº¢', 3000, () =>
      task('ğŸŸ¢ ç»¿', 2000, () =>
        task('ğŸŸ¡ é»„', 1000, loop)  // é€’å½’å½¢æˆå¾ªç¯
      )
    )
  }
  
  loop()
}

// âœ… å¯åŠ¨
redGreenLight()
```

---

## ğŸ”„ 10. Promisify

### æ¨å¯¼é“¾

```
Q1: å¹²å˜›ç”¨ï¼Ÿ
â†’ æŠŠ callback é£æ ¼è½¬æˆ Promise é£æ ¼

Q2: callback æ ¼å¼ï¼Ÿ
â†’ fn(args..., (err, result) => {})

Q3: æ€ä¹ˆè½¬ï¼Ÿ
â†’ è¿”å›æ–°å‡½æ•°ï¼Œå†…éƒ¨ new Promise åŒ…è£…
```

### ä»£ç å®ç°

```javascript
function promisify(fn) {
  return function(...args) {
    return new Promise((resolve, reject) => {
      // æ³¨å…¥ callback ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°
      fn(...args, (err, result) => {
        if (err) reject(err)
        else resolve(result)
      })
    })
  }
}

// âœ… ä½¿ç”¨ç¤ºä¾‹ï¼ˆNode.js fsï¼‰
const fs = require('fs')
const readFile = promisify(fs.readFile)

readFile('test.txt', 'utf8')
  .then(content => console.log(content))
  .catch(err => console.error(err))

// æ”¯æŒå¤šå‚æ•°çš„ callbackï¼ˆå¦‚ fs.readdirï¼‰
function promisifyMulti(fn) {
  return function(...args) {
    return new Promise((resolve, reject) => {
      fn(...args, (err, ...results) => {
        if (err) reject(err)
        else resolve(results.length <= 1 ? results[0] : results)
      })
    })
  }
}
```

---

## ğŸ“¡ 11. å‘å¸ƒè®¢é˜… + è§‚å¯Ÿè€…æ¨¡å¼

### æ¨å¯¼é“¾

```
Q1: å‘å¸ƒè®¢é˜…æ˜¯ä»€ä¹ˆï¼Ÿ
â†’ äº‹ä»¶ä¸­å¿ƒï¼šon è®¢é˜…ã€emit å‘å¸ƒã€off å–æ¶ˆ
â†’ å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¸ç›´æ¥é€šä¿¡ï¼Œé€šè¿‡äº‹ä»¶ä¸­å¿ƒ

Q2: è§‚å¯Ÿè€…æ¨¡å¼åŒºåˆ«ï¼Ÿ
â†’ è§‚å¯Ÿè€…ç›´æ¥è®¢é˜…ç›®æ ‡ï¼Œç›®æ ‡ç›´æ¥é€šçŸ¥è§‚å¯Ÿè€…
â†’ æ²¡æœ‰ä¸­é—´çš„äº‹ä»¶ä¸­å¿ƒ

Q3: æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Ÿ
â†’ å‘å¸ƒè®¢é˜…ï¼š{ eventName: [cb1, cb2] }
â†’ è§‚å¯Ÿè€…ï¼šobservers: [observer1, observer2]
```

### å¯¹æ¯”è¡¨

| ç‰¹æ€§ | å‘å¸ƒè®¢é˜… | è§‚å¯Ÿè€… |
|------|---------|--------|
| è€¦åˆåº¦ | æ¾è€¦åˆï¼ˆæœ‰ä¸­é—´å±‚ï¼‰ | ç´§è€¦åˆï¼ˆç›´æ¥å¼•ç”¨ï¼‰ |
| é€šä¿¡æ–¹å¼ | é€šè¿‡äº‹ä»¶ä¸­å¿ƒ | ç›®æ ‡ç›´æ¥è°ƒè§‚å¯Ÿè€… |
| å…¸å‹åœºæ™¯ | EventEmitterã€Vueäº‹ä»¶æ€»çº¿ | MobXã€Vueå“åº”å¼ |

### ä»£ç å®ç°

```javascript
// ğŸ¯ å‘å¸ƒè®¢é˜…æ¨¡å¼
class EventEmitter {
  constructor() {
    this.events = {}
  }

  on(event, callback, ctx) {
    if (!this.events[event]) this.events[event] = []
    this.events[event].push({ callback, ctx })
    return this  // æ”¯æŒé“¾å¼
  }

  once(event, callback, ctx) {
    const wrapper = (...args) => {
      callback.apply(ctx, args)
      this.off(event, wrapper)
    }
    wrapper._origin = callback  // ç”¨äº off æ—¶åŒ¹é…
    return this.on(event, wrapper, ctx)
  }

  emit(event, ...args) {
    const listeners = this.events[event] || []
    listeners.forEach(({ callback, ctx }) => {
      callback.apply(ctx, args)
    })
    return this
  }

  off(event, callback) {
    if (!event) {
      this.events = {}  // æ¸…ç©ºæ‰€æœ‰
      return this
    }
    if (!callback) {
      delete this.events[event]  // æ¸…ç©ºè¯¥äº‹ä»¶
      return this
    }
    // ç§»é™¤ç‰¹å®šå›è°ƒ
    this.events[event] = (this.events[event] || []).filter(
      item => item.callback !== callback && item.callback._origin !== callback
    )
    return this
  }
}

// ğŸ‘ï¸ è§‚å¯Ÿè€…æ¨¡å¼
class Subject {
  constructor() {
    this.observers = []
  }

  subscribe(observer) {
    this.observers.push(observer)
  }

  unsubscribe(observer) {
    this.observers = this.observers.filter(o => o !== observer)
  }

  notify(data) {
    this.observers.forEach(observer => observer.update(data))
  }
}

class Observer {
  constructor(name) {
    this.name = name
  }
  update(data) {
    console.log(`${this.name} received: ${data}`)
  }
}

// âœ… æµ‹è¯•
const emitter = new EventEmitter()
emitter.on('data', (val) => console.log('Got:', val))
emitter.emit('data', 'Hello')  // Got: Hello

const subject = new Subject()
subject.subscribe(new Observer('A'))
subject.subscribe(new Observer('B'))
subject.notify('Update!')  // A/B éƒ½æ”¶åˆ°
```

---

## ğŸ‘¨â€ğŸ’» 12. CodingMan é“¾å¼è°ƒç”¨

### æ¨å¯¼é“¾

```
Q1: éœ€æ±‚ï¼Ÿ
â†’ é“¾å¼è°ƒç”¨ + å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—

Q2: æ€ä¹ˆé“¾å¼ï¼Ÿ
â†’ æ¯ä¸ªæ–¹æ³• return this

Q3: æ€ä¹ˆç­‰é“¾å¼è°ƒç”¨å®Œå†æ‰§è¡Œï¼Ÿ
â†’ setTimeout å®ä»»åŠ¡å»¶è¿Ÿå¯åŠ¨

Q4: æ€ä¹ˆä¸²è¡Œæ‰§è¡Œï¼Ÿ
â†’ ä¸¤ç§æ–¹æ¡ˆï¼šnext() å†…éƒ¨é©±åŠ¨ / for await å¤–éƒ¨è¿­ä»£

Q5: sleepFirst æ€ä¹ˆæ’é˜Ÿï¼Ÿ
â†’ unshift åˆ°é˜Ÿåˆ—å¤´éƒ¨
```

### å˜ä½“é€ŸæŸ¥

| å½¢æ€ | æ ¸å¿ƒæ€è·¯ |
|------|---------|
| `next()` é©±åŠ¨ | æ¯ä¸ªä»»åŠ¡æ‰§è¡Œå®Œè°ƒ `this.next()` |
| `for await` è¿­ä»£ | ä»»åŠ¡è¿”å› Promiseï¼Œå¤–éƒ¨ `await` éå† |

### ä»£ç å®ç°ï¼ˆæ–¹æ¡ˆä¸€ï¼šnext() å†…éƒ¨é©±åŠ¨ï¼‰

```javascript
function CodingMan(name) {
  const queue = []

  const next = () => {
    const task = queue.shift()
    task && task()
  }

  const ctx = {
    eat(food) {
      queue.push(() => {
        console.log(`Eat ${food}`)
        next()
      })
      return this
    },

    sleep(sec) {
      queue.push(() => {
        console.log(`Sleep ${sec}s...`)
        setTimeout(() => { 
          console.log('Wake up')
          next() 
        }, sec * 1000)
      })
      return this
    },

    sleepFirst(sec) {
      queue.unshift(() => {
        console.log(`Sleep ${sec}s...`)
        setTimeout(() => { 
          console.log('Wake up')
          next() 
        }, sec * 1000)
      })
      return this
    }
  }

  // åˆå§‹ä»»åŠ¡
  queue.push(() => { 
    console.log(`Hi, I am ${name}`)
    next() 
  })

  // å®ä»»åŠ¡å»¶è¿Ÿï¼šç­‰é“¾å¼è°ƒç”¨æ„å»ºå®Œé˜Ÿåˆ—å†å¯åŠ¨
  setTimeout(() => next())

  return ctx
}

// âœ… æµ‹è¯•
CodingMan('Jack')
  .eat('breakfast')
  .sleep(2)
  .eat('lunch')
// è¾“å‡º:
// Hi, I am Jack
// Eat breakfast
// Sleep 2s...
// Wake up
// Eat lunch

CodingMan('Jack')
  .sleepFirst(2)
  .eat('breakfast')
// è¾“å‡º:
// Sleep 2s...
// Wake up
// Hi, I am Jack
// Eat breakfast
```

### ä»£ç å®ç°ï¼ˆæ–¹æ¡ˆäºŒï¼šfor await å¤–éƒ¨è¿­ä»£ï¼‰

```javascript
function CodingManV2(name) {
  const queue = []

  const ctx = {
    eat(food) {
      queue.push(() => console.log(`Eat ${food}`))
      return this
    },

    sleep(sec) {
      queue.push(() => new Promise(resolve => {
        console.log(`Sleep ${sec}s...`)
        setTimeout(() => { 
          console.log('Wake up')
          resolve() 
        }, sec * 1000)
      }))
      return this
    },

    sleepFirst(sec) {
      queue.unshift(() => new Promise(resolve => {
        console.log(`Sleep ${sec}s...`)
        setTimeout(() => { 
          console.log('Wake up')
          resolve() 
        }, sec * 1000)
      }))
      return this
    }
  }

  // åˆå§‹ä»»åŠ¡
  queue.push(() => console.log(`Hi, I am ${name}`))

  // å»¶è¿Ÿæ‰§è¡Œ + ä¸²è¡Œéå†
  setTimeout(async () => {
    for (const task of queue) {
      await task()
    }
  })

  return ctx
}
```

---

## ğŸ“‹ é™„å½•ï¼šå¸¸ç”¨å·¥å…·å‡½æ•°

```javascript
// ğŸ¯ é˜²æŠ–
function debounce(fn, delay) {
  let timer = null
  return function(...args) {
    clearTimeout(timer)
    timer = setTimeout(() => fn.apply(this, args), delay)
  }
}

// ğŸ¯ èŠ‚æµ
function throttle(fn, interval) {
  let last = 0
  return function(...args) {
    const now = Date.now()
    if (now - last >= interval) {
      last = now
      fn.apply(this, args)
    }
  }
}

// ğŸ¯ æ·±åº¦å…‹éš†ï¼ˆç®€åŒ–ç‰ˆï¼‰
function deepClone(obj, hash = new WeakMap()) {
  if (obj === null || typeof obj !== 'object') return obj
  if (obj instanceof Date) return new Date(obj)
  if (obj instanceof RegExp) return new RegExp(obj)
  if (hash.has(obj)) return hash.get(obj)
  
  const clone = Array.isArray(obj) ? [] : {}
  hash.set(obj, clone)
  
  for (const key in obj) {
    if (obj.hasOwnProperty(key)) {
      clone[key] = deepClone(obj[key], hash)
    }
  }
  return clone
}
```

---

> ğŸ’¡ **å­¦ä¹ å»ºè®®**
> 1. å…ˆç†è§£ Promise çŠ¶æ€æœºæ¨¡å‹
> 2. æ‰‹å†™æ ¸å¿ƒ `then` æ–¹æ³•ï¼Œç†è§£é“¾å¼åŸç†
> 3. æŒæ¡ `Promise.all/race` çš„å¹¶å‘æ§åˆ¶æ€æƒ³
> 4. é€šè¿‡ CodingMan ç»ƒä¹ ä»»åŠ¡é˜Ÿåˆ— + å¼‚æ­¥ä¸²è¡Œ

> ğŸ“Œ **é¢è¯•é«˜é¢‘**
> - Promise çŠ¶æ€ä¸ºä»€ä¹ˆä¸å¯é€†ï¼Ÿ
> - then è¿”å›çš„æ–° Promise çŠ¶æ€å¦‚ä½•å†³å®šï¼Ÿ
> - all å’Œ race çš„é€‚ç”¨åœºæ™¯ï¼Ÿ
> - å¾®ä»»åŠ¡ vs å®ä»»åŠ¡æ‰§è¡Œæ—¶æœºï¼Ÿ

---

*âœ¨ å¤åˆ¶å³ç”¨ï¼Œç¥ä½ é¢è¯•é¡ºåˆ©ï¼*